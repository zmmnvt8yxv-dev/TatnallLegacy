<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Trade Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base href="./" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    :root{--muted:#9ca3af;--bd:#2f2f2f}
    body{margin:0;background:#0b1320;color:#e5e7eb;font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;position:sticky;top:0;background:#0b1320;z-index:1}
    .pill{padding:.45rem .75rem;border:1px solid var(--bd);border-radius:.75rem;color:#d1d5db;text-decoration:none}
    .pill:hover{background:#111827}
    .muted{color:var(--muted)}
    main{padding:12px 16px}
    #log{white-space:pre-wrap;margin:0 16px 8px 16px;color:#f59e0b}
    .card{border:1px solid var(--bd);border-radius:.75rem;padding:12px;margin:12px 0}
    .row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px}
    .party{border:1px solid var(--bd);border-radius:.65rem;padding:10px;margin:8px 0}
    .grade{display:flex;align-items:center;gap:8px;margin-top:8px}
    .bar{height:6px;border-radius:4px;background:#0f172a;overflow:hidden;flex:1}
    .bar>span{display:block;height:100%}
    #q{min-width:260px}
    .legend{font-size:.85rem;margin:6px 16px 0 16px}
  </style>
</head>
<body>
  <header>
    <a class="pill" href="index.html">← Back</a>
    <h1 style="margin:0;font-size:1.25rem">Trade Analysis</h1>
    <input id="q" type="search" placeholder="Search player/team…" aria-label="Search" />
  </header>

  <div id="log" class="muted"></div>
  <div id="meta" class="muted" style="margin:0 16px 8px 16px;"></div>
  <div class="legend muted">Grade heuristic: per-player value (stars table → position baseline). Δ = received − sent. Grade = clamp(50 + 0.6 × Δ).</div>
  <main id="list"></main>

  <script>
  (async function(){
    const log = document.getElementById('log');
    const meta = document.getElementById('meta');
    const list = document.getElementById('list');
    const q = document.getElementById('q');

    const DATA_URL = new URL('data/trades-2025.json', location.href).toString();

    // ---- valuation model (editable) ----
    const POS_BASE = { QB:60, RB:70, WR:68, TE:60 };
    const STAR_VALUE = Object.fromEntries([
      // Elite / commonly traded names in your 2025 file (extend freely)
      ['A.J. Brown',92], ['Jalen Hurts',90], ['Saquon Barkley',88], ['Sam LaPorta',88],
      ['Breece Hall',88], ['Jahmyr Gibbs',90], ['Bijan Robinson',88],
      ['Jaylen Waddle',86], ['DeVonta Smith',86], ['Garrett Wilson',88],
      ['Derrick Henry',82], ['Josh Jacobs',82], ['Alvin Kamara',80], ['Tee Higgins',80],
      ['George Kittle',82], ['Mike Evans',84], ['Nick Chubb',80], ['Kenneth Walker',84],
      ['Caleb Williams',84], ['Jayden Daniels',85], ['J.J. McCarthy',78], ['Bo Nix',76],
      ['Blake Corum',80], ['Brian Thomas',80], ['Tetairoa McMillan',78], ['Ashton Jeanty',78],
      ['Jordan Addison',82], ['Courtland Sutton',78], ['Jake Ferguson',76], ['George Pickens',78],
      ['Kareem Hunt',74], ['Kyle Monangai',76], ['Jaylen Warren',74], ['RJ Harvey',72],
      ['Quentin Johnston',72], ['Troy Franklin',74], ['Woody Marks',70], ['Aaron Jones',78],
    ]);

    const K = 0.6;                          // scaling from value delta → grade
    const clamp = (x,min,max)=> Math.max(min, Math.min(max, x));
    const colorFor = g => g>=70?'#22c55e': g>=60?'#84cc16': g>=50?'#f59e0b':'#ef4444';

    function el(t,a={},...kids){const n=document.createElement(t);for(const[k,v] of Object.entries(a))(k==='class')?n.className=v:n.setAttribute(k,v);for(const k of kids)n.append(k?.nodeType?k:document.createTextNode(String(k??"")));return n;}

    function playerValue(p){
      const name = (p?.name||'').trim();
      if (STAR_VALUE[name] != null) return STAR_VALUE[name];
      const pos = (p?.pos||'').toUpperCase();
      return POS_BASE[pos] != null ? POS_BASE[pos] : 65; // fallback
    }

    function partyValueList(arr){ return (arr||[]).reduce((s,x)=> s + playerValue(x), 0); }

    function partyGrade(p){
      const got  = partyValueList(p.gained_players);
      const sent = partyValueList(p.sent_players);
      const delta = got - sent;
      const grade = clamp(50 + K * delta, 0, 100);
      return { delta, grade };
    }

    function partyBlock(p){
      const got  = (p.gained_players||[]).map(x=>x.name);
      const sent = (p.sent_players||[]).map(x=>x.name);
      const gotP = (p.gained_picks||[]).map(x=>`Pick ${x.season??""} R${x.round??""}`);
      const senP = (p.sent_picks||[]).map(x=>`Pick ${x.season??""} R${x.round??""}`);

      const { delta, grade } = partyGrade(p);
      const pct = clamp(grade, 4, 100);

      return el('div',{class:'party'},
        el('div',{style:'font-weight:700;margin-bottom:6px'}, p.team || `Roster ${p.roster_id||""}`),
        el('div',{}, el('span',{class:'muted'},'Received: '), (got.length||gotP.length)? [...got,...gotP].join(', ') : '—'),
        el('div',{}, el('span',{class:'muted'},'Sent: '),     (sent.length||senP.length)? [...sent,...senP].join(', ') : '—'),
        el('div',{class:'grade'},
          el('span',{class:'muted'}, `Δ ${delta.toFixed(1)}  •  Grade ${grade.toFixed(0)}`),
          el('div',{class:'bar'}, el('span',{style:`width:${pct}%;background:${colorFor(grade)}`}))
        )
      );
    }

    function draw(trades){
      const needle = (q.value||'').trim().toLowerCase();
      list.innerHTML = '';
      let shown = 0;
      for(const t of trades){
        const hay = (t.parties||[]).map(p => [
          p.team,
          ...(p.gained_players||[]).map(x=>x.name),
          ...(p.sent_players||[]).map(x=>x.name)
        ].join(' ')).join(' ').toLowerCase();
        if (needle && !hay.includes(needle)) continue;

        const header = (t.parties||[]).map(p=>p.team).filter(Boolean).join(' ↔ ');
        const card = el('section',{class:'card'},
          el('div',{class:'row'},
            el('strong',{}, `Week ${t.week ?? '—'}`),
            el('span',{class:'muted'}, header)
          )
        );
        (t.parties||[]).forEach(p => card.appendChild(partyBlock(p)));
        list.appendChild(card);
        shown++;
      }
      if (shown===0) list.appendChild(el('div',{class:'card muted'}, 'No trades match your filter.'));
    }

    try{
      log.textContent = `Fetching: ${DATA_URL}`;
      const r = await fetch(DATA_URL + (DATA_URL.includes('?')?'&':'?') + 'v=' + Date.now(), {cache:'no-store'});
      if(!r.ok){ log.textContent = `Fetch failed: HTTP ${r.status} — ${DATA_URL}`; return; }
      const data = await r.json();
      if(!data || !Array.isArray(data.trades)){ log.textContent = `JSON loaded but malformed (missing "trades" array).`; return; }

      const trades = data.trades.slice().sort((a,b)=>(a.week??0)-(b.week??0)||(a.created??0)-(b.created??0));
      meta.textContent = `${trades.length} trades • Season ${data.year ?? 2025}`;
      log.textContent = `Loaded ${trades.length} trades from ${DATA_URL}`;

      draw(trades);
      q.oninput = () => draw(trades);
    }catch(e){
      log.textContent = `Runtime error: ${String(e && e.message || e)}`;
      console.error(e);
    }
  })();
  </script>
</body>
</html>
