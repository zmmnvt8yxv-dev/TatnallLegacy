name: Update Sleeper 2025 JSON

on:
  workflow_dispatch:
  schedule:
    - cron: "17 13 * * 2"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate 2025 JSON from Sleeper
        env:
          LEAGUE_ID: "1262418074540195841"
          SEASON: "2025"
        run: |
          python - <<'PY'
import os, json, urllib.request
from pathlib import Path

LEAGUE_ID=os.environ["LEAGUE_ID"]
SEASON=int(os.environ["SEASON"])

def jget(url):
    with urllib.request.urlopen(url) as r:
        return json.loads(r.read().decode("utf-8"))

league=jget(f"https://api.sleeper.app/v1/league/{LEAGUE_ID}")
rosters=jget(f"https://api.sleeper.app/v1/league/{LEAGUE_ID}/rosters")
users=jget(f"https://api.sleeper.app/v1/league/{LEAGUE_ID}/users")

matchups=[]
for w in range(1, 19):
    ms=jget(f"https://api.sleeper.app/v1/league/{LEAGUE_ID}/matchups/{w}")
    for m in ms:
        if not isinstance(m, dict):
            continue
        m["week"]=w
        m["league_id"]=LEAGUE_ID
        if m.get("points") is None:
            sp=m.get("starters_points") or []
            m["points"]=sum(x for x in sp if isinstance(x,(int,float)))
    matchups.extend(ms)

out={
    "season": SEASON,
    "league_id": LEAGUE_ID,
    "league_name": league.get("name"),
    "users": users,
    "rosters": rosters,
    "matchups": matchups,
}

Path("data").mkdir(parents=True, exist_ok=True)
Path("public/data").mkdir(parents=True, exist_ok=True)
Path("data/2025.json").write_text(json.dumps(out, ensure_ascii=False, separators=(",",":")), encoding="utf-8")
Path("public/data/2025.json").write_text(json.dumps(out, ensure_ascii=False, separators=(",",":")), encoding="utf-8")

w17=[m for m in matchups if isinstance(m,dict) and m.get("week")==17]
vals=sorted([round(float(m.get("points") or 0),2) for m in w17], reverse=True)
print("wrote data/2025.json and public/data/2025.json")
print("week17_points_sorted_desc", vals)
PY

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/2025.json public/data/2025.json .github/workflows/sleeper_2025.yml
          git diff --cached --quiet || git commit -m "Update Sleeper 2025 data"
          git push
