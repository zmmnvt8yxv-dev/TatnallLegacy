name: Sleeper 2025 (Weekly + Manual)

on:
  schedule:
    - cron: "0 13 * * 2"
  workflow_dispatch:
    inputs:
      force:
        description: "Commit even if no file changes"
        required: false
        default: "false"

permissions:
  contents: write

concurrency:
  group: sleeper-2025
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Generate Sleeper 2025 JSON
        run: |
          python TatnallLegacy/sleeper_2025_to_json.py

      - name: Sanity check week 17 exists and not all zeros
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          p = Path("public/data/2025.json")
          if not p.exists():
            raise SystemExit("public/data/2025.json missing")
          j = json.loads(p.read_text(encoding="utf-8"))
          w17 = [m for m in j.get("matchups", []) if isinstance(m, dict) and m.get("week") == 17]
          if len(w17) < 8:
            raise SystemExit(f"week 17 rows too small: {len(w17)}")
          pts = [float(m.get("points") or 0) for m in w17]
          if sum(1 for x in pts if x > 0) < 6:
            raise SystemExit(f"week 17 looks mostly zero: {pts}")
          print("week17_ok", sorted([round(x,2) for x in pts], reverse=True))
          PY

      - name: Commit & push if changed (or forced)
        env:
          FORCE: "${{ github.event.inputs.force || 'false' }}"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/2025.json public/data/2025.json .github/workflows/sleeper-2025.yml
          if git diff --cached --quiet; then
            if [ "${FORCE}" = "true" ]; then
              git commit --allow-empty -m "Refresh Sleeper 2025 data (forced)"
              git push
            fi
          else
            git commit -m "Refresh Sleeper 2025 data"
            git push
          fi
